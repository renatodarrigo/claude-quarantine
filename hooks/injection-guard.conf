# claude-guard — Configuration
# See: https://github.com/renatodarrigo/claude-guard

# --- Guard Mode ---
# "enforce" (default): block/warn as configured
# "audit": log + warn only, never block, no rate limit penalties
GUARD_MODE=enforce

# --- Layer Toggles ---
ENABLE_LAYER0=true          # Pre-tool-use URL blocklist (~10ms)
ENABLE_LAYER1=true          # Pattern scanner (fast, ~50-200ms)
ENABLE_LAYER2=false         # LLM analysis (slow, ~2-5s) — enable for high-risk sessions
ENABLE_LAYER3=true          # MCP proxy (requires proxy tools, ~100-500ms on top of fetch)
ENABLE_LAYER4=true          # Rate limiting (exponential backoff)

# --- Layer 0 Settings ---
BLOCKLIST_FILE=~/.claude/hooks/blocklist.conf
BLOCKLIST_REMOTE_URL=
BLOCKLIST_REMOTE_CACHE_TTL=86400

# --- Layer 1 Settings ---
LAYER1_TIMEOUT=5            # Timeout in seconds for pattern scanning

# --- Layer 2 Settings ---
# Requires `claude` CLI (ships with Claude Code).
# Only runs when Layer 1 didn't already find HIGH severity.
# Gracefully degrades if claude CLI is missing or times out.
# Adds ~2-5s latency per tool call when enabled.
LAYER2_MAX_CHARS=10000      # Max content length sent to LLM analysis (truncated if larger)
LAYER2_TIMEOUT=15           # Timeout in seconds for LLM analysis
LAYER2_MODEL=               # Model for Layer 2 analysis (empty = default)

# --- Layer 4 Settings ---
LAYER4_TIMEOUT=5            # Timeout in seconds for rate limit python3 calls

# --- Threat Response ---
# What to do on HIGH threat: "block" (exit 2, halts Claude) or "warn" (systemMessage only)
HIGH_THREAT_ACTION=block

# --- Per-Category Action Overrides ---
# Format: ACTION_<category>=block|warn|silent
# Overrides HIGH_THREAT_ACTION for specific categories.
# "silent": log only, no systemMessage, exit 0
# "warn": systemMessage, exit 0
# "block": systemMessage, exit 2
# Falls back to HIGH_THREAT_ACTION when no override exists.
# Examples:
# ACTION_social_engineering=warn
# ACTION_credential_exfil=block
# ACTION_encoded_payload=silent

# --- Sanitization Strategies ---
# Per-severity sanitization in MCP layer: redact | annotate | quarantine | passthrough
SANITIZE_HIGH=redact
SANITIZE_MED=annotate
QUARANTINE_DIR=~/.claude/hooks/quarantine

# --- Pattern Severity Overrides ---
PATTERN_OVERRIDES_FILE=~/.claude/hooks/pattern-overrides.conf

# --- Allowlisting ---
ALLOWLIST_FILE=~/.claude/hooks/allowlist.conf

# --- Logging ---
LOG_FILE=~/.claude/hooks/injection-guard.log
LOG_THRESHOLD=MED           # Minimum level to log: LOW, MED, HIGH

# --- Log Rotation ---
LOG_MAX_SIZE=10M            # Max log file size before rotation (K/M/G suffixes)
LOG_MAX_ENTRIES=10000       # Max log entries before rotation
LOG_ROTATE_COUNT=3          # Number of rotated files to keep

# --- Scan Cache ---
ENABLE_SCAN_CACHE=true
SCAN_CACHE_TTL=300          # Cache TTL in seconds
SCAN_CACHE_FILE=~/.claude/hooks/scan-cache.json

# --- Session Buffer (Split Payload Detection) ---
ENABLE_SESSION_BUFFER=true
SESSION_BUFFER_SIZE=5       # Number of recent tool outputs to buffer
SESSION_BUFFER_TTL=60       # Buffer entry expiry in seconds
SESSION_BUFFER_FILE=~/.claude/hooks/session-buffer.json

# --- Rate Limiting (Exponential Backoff) ---
# Block sources that repeatedly send malicious input
ENABLE_RATE_LIMIT=true

# State file location (JSON with source tracking)
RATE_LIMIT_STATE_FILE=~/.claude/hooks/rate-limit-state.json

# Backoff parameters (lenient defaults)
RATE_LIMIT_BASE_TIMEOUT=30      # Initial block duration (seconds)
RATE_LIMIT_MULTIPLIER=1.5       # Exponential multiplier (1.5x, 2x, 3x, etc)
RATE_LIMIT_MAX_TIMEOUT=43200    # Maximum block duration (12 hours)
RATE_LIMIT_DECAY_PERIOD=3600    # Clean period for decay (1 hour)

# Severity threshold (which threats trigger rate limiting)
RATE_LIMIT_SEVERITY_HIGH=true   # Rate-limit HIGH threats
RATE_LIMIT_SEVERITY_MED=true    # Rate-limit MED threats
RATE_LIMIT_SEVERITY_LOW=false   # Don't rate-limit LOW threats

# Persistence (maintain blocks across restarts)
RATE_LIMIT_PERSIST=true         # Keep state across reboots
